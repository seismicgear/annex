# Annex full stack: server + LiveKit + voice models.
#
# Usage:
#   docker compose up -d
#
# The Annex server will be available at http://localhost:3000
# LiveKit dev server at ws://localhost:7880

services:
  annex:
    build: .
    ports:
      - "3000:3000"
    environment:
      - ANNEX_HOST=0.0.0.0
      - ANNEX_PORT=3000
      - ANNEX_DB_PATH=/app/data/annex.db
      - ANNEX_LIVEKIT_URL=ws://livekit:7880
      - ANNEX_LIVEKIT_PUBLIC_URL=ws://localhost:7880
      - ANNEX_LIVEKIT_API_KEY=${ANNEX_LIVEKIT_API_KEY:-devkey}
      - ANNEX_LIVEKIT_API_SECRET=${ANNEX_LIVEKIT_API_SECRET:-secret}
      - ANNEX_CORS_ORIGINS=*
      - ANNEX_LOG_LEVEL=info
      - ANNEX_LOG_JSON=true
      - ANNEX_TTS_BINARY_PATH=/app/assets/piper/piper
      - ANNEX_TTS_VOICES_DIR=/app/assets/voices
    volumes:
      - annex-data:/app/data
    depends_on:
      - livekit
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:latest
    command: --dev --bind 0.0.0.0
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
    environment:
      - "LIVEKIT_KEYS=${ANNEX_LIVEKIT_API_KEY:-devkey}: ${ANNEX_LIVEKIT_API_SECRET:-secret}"
    restart: unless-stopped

volumes:
  annex-data:
